{% extends './calendario_base.html' %}
{% load static %}

{% block title %}Calendario de Actividades{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
<style>
  /* Distribuci√≥n en columnas */
  .cal-wrap{display:grid;grid-template-columns:420px 1fr;gap:18px;width:100%}
  /* Panel lateral como tarjeta */
  .side{border:1px solid #dae4f2;border-radius:10px;background:#fff;padding:12px;
        box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .side-title{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-weight:800;color:#2a5686}
  .side-date{font-weight:700;color:#2a5686;margin:6px 0 10px}
  /* Tabla dentro del panel lateral */
  .side-table{border:1px solid #e5ebf5;border-radius:8px;overflow:hidden}
  .side-table .head-row{display:grid;grid-template-columns: 1fr 120px 120px;
                        background:#eff4fb;font-weight:800;color:#2a5686;border-bottom:1px solid #e5ebf5}
  .side-table .head-row .col{padding:10px 12px}
  .side-table .row{display:grid;grid-template-columns: 1fr 120px 120px;
                   border-bottom:1px dashed #e9eef5;align-items:center}
  .side-table .row:last-child{border-bottom:0}
  .side-table .row .col{padding:10px 12px}
  .side-table .row.empty{padding:12px;color:#6b7485}
  .side-table .col.ev{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .side-table .col.t{text-align:center}
  /* Estilos para el t√≠tulo y descripci√≥n dentro de la columna de evento */
  .side-table .event-title{font-weight:600;}
  .side-table .event-desc{font-size:0.8rem;color:#6b7485;}
  /* Contenedor del calendario */
  #calendar{background:#fff;border:1px solid #d9e3ef;border-radius:12px;padding:8px;
            box-shadow:0 10px 28px rgba(0,0,0,.08)}
  /* Estilos de la barra del calendario */
  .fc .fc-toolbar.fc-header-toolbar{
    background:linear-gradient(180deg,#2f68a8,#2a5686);
    color:#fff;border-radius:10px;padding:10px 16px;margin-bottom:8px
  }
  .fc .fc-toolbar-title{font-size:1.4rem;font-weight:800}
  /* Estilo de los eventos como badge (usamos fc-daygrid-event) */
  .fc-daygrid-event{border:none;background:#2a5686;color:#fff;border-radius:999px;padding:2px 7px;
                    font-weight:700;font-size:.75rem;display:inline-block}
</style>

<div class="cal-wrap">
  <aside class="side">
    <div class="side-title">
      <span>üë§</span>
      <h3>Actividades del d√≠a</h3>
    </div>
    <div id="side-date" class="side-date">Seleccion√° una fecha</div>
    <div id="side-list" class="side-table">
      <div class="row empty">‚Äî</div>
    </div>
  </aside>

  <div id="calendar"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calEl    = document.getElementById('calendar');
  const sideDate = document.getElementById('side-date');
  const sideList = document.getElementById('side-list');

  const calendar = new FullCalendar.Calendar(calEl, {
    initialView: 'dayGridMonth',
    locale: 'es',
    firstDay: 0,
    height: 'auto',
    headerToolbar: { left: 'prev', center: 'title', right: 'next' },
    events: '{% url "calendario_events" %}',
    // Representamos cada d√≠a con el n√∫mero de actividades realizadas
    eventContent: function(arg){
      return { html: `<span class="fc-daygrid-event">${arg.event.title}</span>` };
    },
    dateClick: function(info){
      const d = info.date;
      const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      // Mostrar la fecha seleccionada en espa√±ol
      sideDate.textContent = d.toLocaleDateString('es-PY', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
      loadDay(iso);
    }
  });

  calendar.render();

  async function loadDay(isoDate){
    sideList.innerHTML = '<div class="row empty">Cargando‚Ä¶</div>';
    try{
      const r = await fetch('{% url "calendario_detalle" %}?date='+isoDate);
      const data = await r.json();
      const items = Array.isArray(data) ? data : (data.items || []);
      if (!items.length){
        sideList.innerHTML = '<div class="row empty">Sin actividades registradas</div>';
        return;
      }
      // Construir cabecera: Actividad | Fecha | Hora
      let html = `
        <div class="head-row">
          <div class="col ev">Actividad</div>
          <div class="col t">Fecha</div>
          <div class="col t">Hora</div>
        </div>
      `;
      html += items.map(it => {
        const d = new Date(it.date);
        const fecha = d.toLocaleDateString('es-PY');
        const hora = d.toLocaleTimeString('es-PY', {hour:'2-digit', minute:'2-digit'});
        return `
          <div class="row">
            <div class="col ev">
              <div class="event-title">${it.title}</div>
              <div class="event-desc">${it.description}</div>
            </div>
            <div class="col t">${fecha}</div>
            <div class="col t">${hora}</div>
          </div>
        `;
      }).join('');
      sideList.innerHTML = html;
    }catch(e){
      sideList.innerHTML = '<div class="row empty">Error al cargar</div>';
    }
  }
});
</script>
{% endblock %}
